name: Build IPA

permissions:
  contents: write

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å‡†å¤‡ Theos ç¯å¢ƒ
        uses: axs666/theos-action@main

      - name: æ„å»ºåº”ç”¨
        run: |
          # æ¸…ç†å¹¶æ„å»º
          make clean || true
          make package FINALPACKAGE=1 THEOS_PACKAGE_SCHEME=rootless
          
          # æŸ¥çœ‹æ„å»ºç»“æœ
          echo "=== æ„å»ºäº§ç‰© ==="
          find .theos -name "*.app" -type d 2>/dev/null || true
          ls -la packages/ 2>/dev/null || true

      - name: åˆ›å»º IPA åŒ…
        run: |
          # ç¡®ä¿ packages ç›®å½•å­˜åœ¨
          mkdir -p packages
          
          # æŸ¥æ‰¾ .app ç›®å½•
          APP_PATH=$(find .theos -name "AuthCodeGen.app" -type d 2>/dev/null | head -1)
          
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find .theos -name "*.app" -type d 2>/dev/null | head -1)
          fi
          
          echo "APP è·¯å¾„: $APP_PATH"
          
          if [ -n "$APP_PATH" ] && [ -d "$APP_PATH" ]; then
            # åˆ›å»º Payload ç›®å½•
            rm -rf Payload
            mkdir -p Payload
            
            # å¤åˆ¶ .app
            cp -r "$APP_PATH" Payload/
            
            # ç­¾å
            APP_NAME=$(basename "$APP_PATH")
            ldid -Sents.plist "Payload/$APP_NAME" 2>/dev/null || echo "ldid ç­¾åè·³è¿‡"
            
            # åˆ›å»º IPA
            zip -qr packages/AuthCodeGen.ipa Payload
            
            echo "âœ… IPA åˆ›å»ºæˆåŠŸ!"
            ls -la packages/
            
            # æ¸…ç†
            rm -rf Payload
          else
            echo "âŒ æœªæ‰¾åˆ° .app ç›®å½•"
            
            # å°è¯•ä» DEB æå–
            DEB_FILE=$(find packages -name "*.deb" 2>/dev/null | head -1)
            if [ -n "$DEB_FILE" ]; then
              echo "ä» DEB æå–: $DEB_FILE"
              
              mkdir -p extracted
              dpkg-deb -x "$DEB_FILE" extracted/
              
              APP_IN_DEB=$(find extracted -name "*.app" -type d | head -1)
              if [ -n "$APP_IN_DEB" ]; then
                mkdir -p Payload
                cp -r "$APP_IN_DEB" Payload/
                
                APP_NAME=$(basename "$APP_IN_DEB")
                ldid -Sents.plist "Payload/$APP_NAME" 2>/dev/null || true
                
                zip -qr packages/AuthCodeGen.ipa Payload
                echo "âœ… ä» DEB åˆ›å»º IPA æˆåŠŸ!"
                ls -la packages/
              fi
              
              rm -rf extracted Payload
            else
              echo "âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°ä»»ä½•äº§ç‰©"
              exit 1
            fi
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: AuthCodeGen-Release
          path: packages/*
          retention-days: 90
          if-no-files-found: error

      - name: åˆ›å»º Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: æˆæƒç ç”Ÿæˆå™¨ v1.0.${{ github.run_number }}
          body: |
            ## ğŸ” å¾®ä¿¡æˆæƒç ç”Ÿæˆå™¨
            
            ### åŠŸèƒ½ç‰¹æ€§
            - âœ¨ ç”Ÿæˆå¾®ä¿¡ç”¨æˆ·æˆæƒç 
            - ğŸ”“ éªŒè¯å’Œè§£å¯†æˆæƒç 
            - ğŸ“‹ ä¸€é”®å¤åˆ¶æˆæƒç 
            - ğŸ¨ ç°ä»£åŒ–æ·±è‰²ä¸»é¢˜ç•Œé¢
            
            ### å®‰è£…æ–¹å¼
            
            **TrollStore (å·¨é­”å•†åº—) - æ¨è**
            1. ä¸‹è½½ `AuthCodeGen.ipa`
            2. åœ¨ TrollStore ä¸­æ‰“å¼€å®‰è£…
          files: packages/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
