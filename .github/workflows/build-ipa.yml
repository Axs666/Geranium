name: Build IPA

permissions:
  contents: write

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: å‡†å¤‡ Theos ç¯å¢ƒ
        uses: axs666/theos-action@main

      - name: å®‰è£… ldid
        run: |
          if command -v ldid &> /dev/null; then
            echo "ldid is already installed."
          else
            brew install ldid
          fi

      - name: æ„å»ºä¸»åº”ç”¨
        run: |
          WORKING_LOCATION="$(pwd)"
          APPLICATION_NAME=Geranium
          CONFIGURATION=Debug
          
          # æ¸…ç†æ„å»ºç›®å½•
          rm -rf build
          mkdir -p build
          
          # ä½¿ç”¨ xcodebuild æ„å»ºåº”ç”¨
          xcodebuild -project "$WORKING_LOCATION/Geranium.xcodeproj" \
            -scheme Geranium \
            -configuration $CONFIGURATION \
            -derivedDataPath "$WORKING_LOCATION/build/DerivedData" \
            -destination 'generic/platform=iOS' \
            ONLY_ACTIVE_ARCH="NO" \
            CODE_SIGNING_ALLOWED="NO" \
            clean build
          
          echo "âœ… ä¸»åº”ç”¨æ„å»ºå®Œæˆ"

      - name: æ„å»º RootHelper
        run: |
          WORKING_LOCATION="$(pwd)"
          
          if [ -d "$WORKING_LOCATION/RootHelper" ]; then
            cd "$WORKING_LOCATION/RootHelper"
            make clean || true
            make
            
            echo "âœ… RootHelper æ„å»ºå®Œæˆ"
          else
            echo "âš ï¸ RootHelper ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi

      - name: å‡†å¤‡åº”ç”¨åŒ…
        run: |
          WORKING_LOCATION="$(pwd)"
          APPLICATION_NAME=Geranium
          CONFIGURATION=Debug
          
          # å¤åˆ¶ .app åˆ° build ç›®å½•
          DD_APP_PATH="$WORKING_LOCATION/build/DerivedData/Build/Products/$CONFIGURATION-iphoneos/$APPLICATION_NAME.app"
          TARGET_APP="$WORKING_LOCATION/build/$APPLICATION_NAME.app"
          
          if [ ! -d "$DD_APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ„å»ºçš„ .app æ–‡ä»¶: $DD_APP_PATH"
            exit 1
          fi
          
          cp -r "$DD_APP_PATH" "$TARGET_APP"
          
          # ç§»é™¤ç­¾å
          codesign --remove "$TARGET_APP" 2>/dev/null || true
          if [ -e "$TARGET_APP/_CodeSignature" ]; then
            rm -rf "$TARGET_APP/_CodeSignature"
          fi
          if [ -e "$TARGET_APP/embedded.mobileprovision" ]; then
            rm -rf "$TARGET_APP/embedded.mobileprovision"
          fi
          
          # å¤åˆ¶ RootHelper
          if [ -f "$WORKING_LOCATION/RootHelper/.theos/obj/debug/GeraniumRootHelper" ]; then
            cp "$WORKING_LOCATION/RootHelper/.theos/obj/debug/GeraniumRootHelper" "$TARGET_APP/GeraniumRootHelper"
            echo "âœ… RootHelper å·²å¤åˆ¶åˆ°åº”ç”¨åŒ…"
          else
            echo "âš ï¸ RootHelper æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          
          echo "âœ… åº”ç”¨åŒ…å‡†å¤‡å®Œæˆ"

      - name: æ·»åŠ  Entitlements å¹¶æ‰“åŒ… IPA
        run: |
          WORKING_LOCATION="$(pwd)"
          APPLICATION_NAME=Geranium
          
          TARGET_APP="$WORKING_LOCATION/build/$APPLICATION_NAME.app"
          
          if [ ! -d "$TARGET_APP" ]; then
            echo "âŒ åº”ç”¨åŒ…ä¸å­˜åœ¨: $TARGET_APP"
            exit 1
          fi
          
          # æ·»åŠ  entitlements
          echo "æ·»åŠ  entitlements..."
          ldid -S"$WORKING_LOCATION/entitlements.plist" "$TARGET_APP/$APPLICATION_NAME"
          
          # ä¸ºæ‰©å±•æ·»åŠ  entitlements
          if [ -d "$TARGET_APP/PlugIns/Bookmark Location in Geranium.appex" ]; then
            ldid -S"$WORKING_LOCATION/Bookmark Location in Geranium/entitlements.plist" "$TARGET_APP/PlugIns/Bookmark Location in Geranium.appex/Bookmark Location in Geranium"
            echo "âœ… æ‰©å±• entitlements å·²æ·»åŠ "
          fi
          
          # åˆ›å»º packages ç›®å½•å¹¶æ‰“åŒ… IPA
          cd "$WORKING_LOCATION/build"
          mkdir -p packages
          rm -rf Payload
          mkdir -p Payload
          cp -r "$APPLICATION_NAME.app" Payload/
          zip -qr "packages/$APPLICATION_NAME.tipa" Payload
          rm -rf Payload
          
          echo "âœ… IPA åˆ›å»ºæˆåŠŸ: build/packages/$APPLICATION_NAME.tipa"
          ls -lah packages/

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Geranium-Release
          path: build/packages/*
          retention-days: 90
          if-no-files-found: error

      - name: åˆ›å»º Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Geranium v1.0.${{ github.run_number }}
          body: |
            ## ğŸ“± Geranium
            
            LocSim, Daemon Manager, Cleaner and Superviser for TrollStore
            
            ### åŠŸèƒ½ç‰¹æ€§
            - ğŸ“ æ¨¡æ‹Ÿè™šæ‹Ÿä½ç½®å’Œä¹¦ç­¾
            - ğŸ§¹ æ¸…ç†è®¾å¤‡å­˜å‚¨ç©ºé—´
            - ğŸ”§ ç®¡ç†ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹
            - â±ï¸ ç¦ç”¨ ScreenTime
            - ğŸ›¡ï¸ è®¾å¤‡ç›‘ç®¡ç®¡ç†
            
            ### å®‰è£…æ–¹å¼
            
            **TrollStore (å·¨é­”å•†åº—) - æ¨è**
            1. ä¸‹è½½ `Geranium.tipa`
            2. åœ¨ TrollStore ä¸­æ‰“å¼€å®‰è£…
            3. æŒ‰ç…§è®¾ç½®æµç¨‹å®Œæˆå®‰è£…
            
            **è¦æ±‚**
            - TrollStore 1.3 æˆ–æ›´é«˜ç‰ˆæœ¬
            - iOS 15 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆå¦‚æœ TrollStore æ”¯æŒï¼‰
          files: build/packages/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
